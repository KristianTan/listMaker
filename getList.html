<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>List Maker - List Viewer</title>
    <link rel="stylesheet" href="static/style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:200,400,700&display=swap" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript">
        id = null;
        code = null;
        function getList(codeValue) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            $.ajax({
                data: {
                    // Change this to be url param from index.html
                    code: urlParams.get('code'),
                    jwt: getCookie('jwt')
                },
                type: 'GET',
                url: 'http://ysjcs.net:5035/getList'
            }).done(function (data) {
                if (data.message === 'No list found for that code') {
                    window.alert('No list found with code: ' + data.code)
                    window.open('index.html', '__self');
                }

                $('#listViewerTitle').text(data.title).show();
                id = data.id;
                code = data.code;
                $('#listId').text('(list code: ' + data.code + ')').show();

                html_list = '<ol id=\'listViewerEntries\'>';
                data.entries.forEach(function (item) {
                    html_list += `<li>${item}</li>`;

                });
                html_list += '</ul>';
                document.getElementById("entryList").innerHTML = html_list;

                if (!data.auth) {
                    document.getElementById("entryList").style.display = "none";
                    document.getElementById("newItemForm").style.display = "none";
                } else {
                    document.getElementById("formPopup").style.display = "none";
                }
            });
        }


        $(document).ready(function () {
            $('#newItemForm').on('submit', function (event) {
                $.ajax({
                    data: {
                        'listId': id,
                        'text': $('#newItemText').val()
                    },
                    type: 'POST',
                    url: 'http://ysjcs.net:5035/newEntry'
                }).done(function () {
                    window.location.reload();
                });
                event.preventDefault();
            });
        });


        $(document).ready(function () {
            $('#formPopup').on('submit', function (event) {
                $.ajax({
                    data: {
                        'listId': id,
                        'passPhrase': $('#popupPassphrase').val(),
                        'code': code
                    },
                    credentials: 'Same-Origin',
                    type: 'POST',
                    url: 'http://ysjcs.net:5035/checkPassphrase'
                }).done(function (data) {
                    if (data.message === "Correct passphrase") {
                        document.cookie = 'jwt=' + data.token;
                        document.getElementById("entryList").style.display = "block";
                        document.getElementById("newItemForm").style.display = "block";
                        document.getElementById("formPopup").style.display = "none";
                    } else {
                        window.alert('Incorrect passphrase');
                    }
                });
                event.preventDefault();
            });
        });

        function getCookie(name) {
            var dc = document.cookie;
            var prefix = name + "=";
            var begin = dc.indexOf("; " + prefix);
            if (begin == -1) {
                begin = dc.indexOf(prefix);
                if (begin != 0) return null;
            } else {
                begin += 2;
                var end = document.cookie.indexOf(";", begin);
                if (end == -1) {
                    end = dc.length;
                }
            }
            // because unescape has been deprecated, replaced with decodeURI
            //return unescape(dc.substring(begin + prefix.length, end));
            return decodeURI(dc.substring(begin + prefix.length, end));
        }

    </script>
</head>

<body onload="getList()">
<div class="header">
    <h1 class="title"><a href="index.html"> List Maker</a></h1>
    <h2 class="subTitle">Create lists to share with your friends!</h2>
</div>

<h2 id="listViewerTitle"></h2>
<h3 id="listId"></h3>

<div id="entryList"></div>

<form id="newItemForm">
    <input id="newItemText" type="text">
</form>

<form id="formPopup">
    <h1>Enter passphrase to edit list:</h1>
    <input type="password" placeholder="" id="popupPassphrase" required>
    <input type="submit" value="Enter">
</form>

</body>
</html>